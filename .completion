#!/bin/zsh

autoload -U +X compinit && compinit
autoload -U +X bashcompinit && bashcompinit
source ~/west-completion.sh

_cdt_completion() {
    _files -W $NCS_WT_PATH -/
}

_gtr_completion() {
    _files -W $NCS_WT_PATH -/
}

_gta_completion() {
    branches=$(git -C $NCS_PATH/nrf branch --sort=-committerdate --format='%(refname:short)')
    branches=${branches//main/}

    # remove existing worktrees
    for dir in $NCS_WT_PATH/*; do
        branches=${branches//$dir:t/}
    done

    # convert newline-separated string to array
    branches=("${(@f)branches}")

    # remove empty elements
    branches=(${branches:#})

    # get the current word being completed
    local curcontext="$curcontext" state line
    typeset -A opt_args
    _arguments -C '*: :->branch' && return 0

    case $state in
        branch)
            local -a match_branches
            # filter and limit branches to 10
            for branch in $branches; do
                if [[ $branch == $line[1]* ]] && (( ${#match_branches} < 10 )); then
                    match_branches+=($branch)
                fi
            done
            _describe -V 'branches' match_branches
            ;;
    esac

}

compdef _cdt_completion cdt
compdef _gtr_completion gtr
compdef _gta_completion gta
